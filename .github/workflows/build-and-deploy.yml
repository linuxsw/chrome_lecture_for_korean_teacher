name: Build and Deploy Chrome Education Materials

on:
  push:
    branches: [main, master, dev, dev3]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wkhtmltopdf pandoc bc
          # í•œê¸€ í°íŠ¸ ì„¤ì¹˜ (PDF í•œê¸€ ì§€ì›)
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          sudo fc-cache -fv
          echo "âœ… System dependencies installed"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-pptx pillow weasyprint markdown reportlab
          echo "âœ… Python dependencies installed"

      - name: Set build timestamp
        run: echo "TIMESTAMP=$(date '+%Y%m%d_%H%M')" >> $GITHUB_ENV

      - name: Create directories
        run: |
          mkdir -p output docs
          echo "âœ… Directories created"

      - name: Generate materials
        run: |
          echo "ğŸš€ Starting material generation..."

          # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python scripts/generate_slides.py

          # Bash ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          bash scripts/generate_materials.sh

          echo "âœ… Material generation completed"

      - name: Verify generated files
        run: |
          echo "ğŸ“‹ Generated files verification:"
          echo "----------------------------------------"

          # í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ í˜•ì‹ì˜ íƒ€ì„ìŠ¤íƒ¬í”„
          TIMESTAMP=$(date +"%Y%m%d_%H%M")

          if [ -f "output/index.html" ]; then
            size=$(stat -c%s "output/index.html")
            echo "âœ… HTML Index: $(printf "%'d" $size) bytes"
          else
            echo "âŒ HTML Index: Missing"
          fi

          # PPTX íŒŒì¼ í™•ì¸ (íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨)
          PPTX_FILE=$(find output -name "chrome_education_slides_*.pptx" | head -n 1)
          if [ -n "$PPTX_FILE" ]; then
            size=$(stat -c%s "$PPTX_FILE")
            mb=$(echo "scale=1; $size / 1024 / 1024" | bc -l)
            echo "âœ… PowerPoint: $(printf "%'d" $size) bytes (${mb} MB)"
            echo "   íŒŒì¼: $(basename "$PPTX_FILE")"
          else
            echo "âŒ PowerPoint: Missing"
          fi

          # PDF íŒŒì¼ í™•ì¸ (íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨)
          PDF_FILE=$(find output -name "chrome_edu_workbook_*.pdf" | head -n 1)
          if [ -n "$PDF_FILE" ]; then
            size=$(stat -c%s "$PDF_FILE")
            kb=$(echo "scale=1; $size / 1024" | bc -l)
            echo "âœ… PDF Workbook: $(printf "%'d" $size) bytes (${kb} KB)"
            echo "   íŒŒì¼: $(basename "$PDF_FILE")"
          else
            echo "âš ï¸ PDF Workbook: Missing (optional)"
          fi

          # HTML ìŠ¬ë¼ì´ë“œ íŒŒì¼ë“¤ ê°œìˆ˜
          html_count=$(find output -name "*.html" -not -name "index.html" | wc -l)
          echo "âœ… HTML Slides: ${html_count} files"

          # Assets í™•ì¸
          if [ -d "output/assets" ]; then
            asset_count=$(find output/assets -type f | wc -l)
            echo "âœ… Assets: ${asset_count} files"
          fi

          # ì´ë¯¸ì§€ í™•ì¸
          if [ -d "output/images" ]; then
            image_count=$(find output/images -type f | wc -l)
            echo "âœ… Images: ${image_count} files"
          fi

          echo "----------------------------------------"
          echo "ğŸ“‚ Complete file listing:"
          ls -la output/

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './output'
          name: chrome-edu-materials-${{ env.TIMESTAMP }}

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    # ì„ì‹œë¡œ ëª¨ë“  ë¸Œëœì¹˜ì—ì„œ ë°°í¬ í—ˆìš© (í…ŒìŠ¤íŠ¸ìš©)
    # if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
