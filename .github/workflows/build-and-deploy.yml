name: Build and Deploy Chrome Education Materials

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wkhtmltopdf pandoc
        # í•œê¸€ í°íŠ¸ ì„¤ì¹˜
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
        sudo fc-cache -fv
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install markdown weasyprint reportlab python-pptx
        
    - name: Create output directory
      run: mkdir -p output
      
    - name: Generate slides and materials
      run: |
        echo "ğŸš€ Starting material generation..."
        
        # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        python scripts/generate_slides.py
        
        # Bash ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        bash scripts/generate_materials.sh
        
        echo "âœ… Material generation completed"
        
    - name: Generate PDF from Markdown (if workbook exists)
      run: |
        if [ -f "docs/chrome_edu_workbook.md" ]; then
          echo "ğŸ“š Converting workbook to PDF..."
          
          # ë°©ë²• 1: WeasyPrint ì‚¬ìš© (í•œê¸€ ì§€ì› ìš°ìˆ˜)
          if python -c "import weasyprint" 2>/dev/null; then
            echo "Using WeasyPrint for PDF generation..."
            python -c "
import weasyprint
from pathlib import Path

# CSS ìŠ¤íƒ€ì¼ ì •ì˜ (í•œê¸€ í°íŠ¸ í¬í•¨)
css_style = '''
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
body {
    font-family: 'Noto Sans KR', 'Noto Sans CJK KR', sans-serif;
    line-height: 1.6;
    margin: 2cm;
    font-size: 12pt;
}
h1, h2, h3, h4, h5, h6 {
    font-weight: 700;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
}
h1 { font-size: 24pt; }
h2 { font-size: 20pt; }
h3 { font-size: 16pt; }
'''

# Markdownì„ HTMLë¡œ ë³€í™˜
import markdown
with open('docs/chrome_edu_workbook.md', 'r', encoding='utf-8') as f:
    md_content = f.read()

html_content = f'''
<!DOCTYPE html>
<html lang=\"ko\">
<head>
    <meta charset=\"UTF-8\">
    <style>{css_style}</style>
</head>
<body>
{markdown.markdown(md_content)}
</body>
</html>
'''

# PDF ìƒì„±
weasyprint.HTML(string=html_content).write_pdf('output/chrome_edu_workbook.pdf')
print('âœ… PDF generated successfully with WeasyPrint')
"
          else
            echo "WeasyPrint not available, using Pandoc with enhanced settings..."
            pandoc docs/chrome_edu_workbook.md -o output/chrome_edu_workbook.pdf \
              --pdf-engine=wkhtmltopdf \
              -V margin-top=20mm \
              -V margin-bottom=20mm \
              -V margin-left=15mm \
              -V margin-right=15mm \
              -V mainfont="Noto Sans CJK KR" \
              --css=<(echo "body { font-family: 'Noto Sans CJK KR', sans-serif; }")
          fi
          
          echo "âœ… PDF conversion completed"
        fi
        
    - name: Generate PowerPoint presentation
      run: |
        echo "ğŸ“Š Creating PowerPoint presentation..."
        python -c "
import json
from pptx import Presentation
from pptx.util import Inches, Pt
from pptx.dml.color import RGBColor
from pptx.enum.text import PP_ALIGN

# ìŠ¬ë¼ì´ë“œ êµ¬ì„± ì •ë³´
slides_config = [
    {'title': 'ìˆ˜ì—…ì„ ì‰½ê²Œ, ìë£Œë¥¼ ì˜ˆì˜ê²Œ, í˜‘ì—…ì„ íš¨ìœ¨ì ìœ¼ë¡œ', 'subtitle': 'ë””ì§€í„¸ ë„êµ¬ ì™„ì „ì •ë³µ\ní•œê¸€í•™êµ ì„ ìƒë‹˜ì„ ìœ„í•œ í¬ë¡¬ ì›¹ë¸Œë¼ìš°ì € í™œìš© êµìœ¡'},
    {'title': 'ê°•ì˜ ê°œìš”', 'content': ['êµìœ¡ ëª©í‘œ ë° ëŒ€ìƒ', 'ê¸°ì´ˆ-ì¤‘ê¸‰-ê³ ê¸‰ ë‹¨ê³„ë³„ êµ¬ì„±', 'ì‹¤ìŠµ ì¤‘ì‹¬ì˜ í•™ìŠµ ë°©ë²•', 'ì§€ì†ì ì¸ í•™ìŠµì„ ìœ„í•œ ì»¤ë®¤ë‹ˆí‹°']},
    {'title': 'ê¸°ì´ˆ ë‹¨ê³„: í¬ë¡¬ ë¸Œë¼ìš°ì € ê¸°ë³¸ ê¸°ëŠ¥', 'content': ['í”„ë¡œí•„ ê´€ë¦¬', 'ë¶ë§ˆí¬ í™œìš©', 'ë‹¨ì¶•í‚¤ í™œìš©', 'ê¸°ë³¸ ì„¤ì • ìµœì í™”']},
    {'title': 'ì¤‘ê¸‰ ë‹¨ê³„: êµìœ¡ìë¥¼ ìœ„í•œ í™•ì¥í”„ë¡œê·¸ë¨', 'content': ['Fireshot - ì›¹í˜ì´ì§€ ìº¡ì²˜', 'Google Keep - ë©”ëª¨ ë° ìŠ¤í¬ë©', 'Video Speed Controller - ë™ì˜ìƒ ì†ë„ ì¡°ì ˆ', 'Mote - ìŒì„± í”¼ë“œë°±']},
    {'title': 'ì¤‘ê¸‰ ë‹¨ê³„: í•œê¸€êµìœ¡ íŠ¹í™” ì›¹ë„êµ¬', 'content': ['ìŠ¤í„°ë””ì½”ë¦¬ì•ˆë„·', 'í•œêµ­ì–´êµìˆ˜í•™ìŠµìƒ˜í„°', 'NAKS ì˜¨ë¼ì¸ ìë£Œì‹¤', 'í•œê¸€ë˜ë°•ë˜ë°•']},
    {'title': 'ê³ ê¸‰ ë‹¨ê³„: êµ¬ê¸€ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì—°ë™', 'content': ['êµ¬ê¸€ í´ë˜ìŠ¤ë£¸', 'êµ¬ê¸€ ë¬¸ì„œ/ìŠ¬ë¼ì´ë“œ', 'êµ¬ê¸€ ë“œë¼ì´ë¸Œ', 'êµ¬ê¸€ ë¯¸íŠ¸']},
    {'title': 'ê³ ê¸‰ ë‹¨ê³„: AI ë„êµ¬ í™œìš©', 'content': ['Brisk Teaching - AI êµì‚¬ ì–´ì‹œìŠ¤í„´íŠ¸', 'ChatGPT - êµìœ¡ ìë£Œ ìƒì„±', 'Canva AI - ì‹œê°ì  ìë£Œ ì œì‘', 'ìŒì„± ì¸ì‹/í•©ì„± ë„êµ¬']},
    {'title': 'ì‹¤ìŠµ ì‹œë‚˜ë¦¬ì˜¤', 'content': ['ìƒˆ í•™ê¸° ì¤€ë¹„ (ê¸°ì´ˆ)', 'íš¨ìœ¨ì ì¸ ìˆ˜ì—… ìë£Œ ì¤€ë¹„ (ì¤‘ê¸‰)', 'ì˜¨ë¼ì¸ ìˆ˜ì—… ì§„í–‰ (ì¤‘ê¸‰)', 'í•™ê¸‰ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶• (ê³ ê¸‰)']},
    {'title': 'ì¶”ê°€ ìë£Œ ë° ì°¸ê³  ë§í¬', 'content': ['í¬ë¡¬ ë¸Œë¼ìš°ì € ê³µì‹ ìë£Œ', 'í•œê¸€êµìœ¡ ìë£Œ', 'ë””ì§€í„¸ êµìœ¡ ë„êµ¬', 'êµì‚¬ ì»¤ë®¤ë‹ˆí‹°']},
    {'title': 'ì§ˆë¬¸ ë° ì—°ë½ì²˜', 'content': ['ì´ë©”ì¼: support@koreanedu.org', 'ì „í™”: 02-123-4567', 'ì›¹ì‚¬ì´íŠ¸: www.koreanedu.org']}
]

# ìƒˆ í”„ë ˆì  í…Œì´ì…˜ ìƒì„±
prs = Presentation()

# í¬ë¡¬ ìƒ‰ìƒ ì •ì˜
chrome_blue = RGBColor(66, 133, 244)
chrome_red = RGBColor(234, 67, 53)
chrome_yellow = RGBColor(251, 188, 5)
chrome_green = RGBColor(52, 168, 83)

for i, slide_data in enumerate(slides_config):
    # ìŠ¬ë¼ì´ë“œ ë ˆì´ì•„ì›ƒ ì„ íƒ
    if i == 0:  # íƒ€ì´í‹€ ìŠ¬ë¼ì´ë“œ
        slide_layout = prs.slide_layouts[0]  # Title Slide
    else:
        slide_layout = prs.slide_layouts[1]  # Title and Content
    
    slide = prs.slides.add_slide(slide_layout)
    
    # ì œëª© ì„¤ì •
    title = slide.shapes.title
    title.text = slide_data['title']
    title.text_frame.paragraphs[0].font.size = Pt(32)
    title.text_frame.paragraphs[0].font.color.rgb = chrome_blue
    
    if i == 0:  # íƒ€ì´í‹€ ìŠ¬ë¼ì´ë“œ
        if slide.placeholders[1]:  # ë¶€ì œëª©
            subtitle = slide.placeholders[1]
            subtitle.text = slide_data['subtitle']
            subtitle.text_frame.paragraphs[0].font.size = Pt(20)
    else:  # ë‚´ìš© ìŠ¬ë¼ì´ë“œ
        if 'content' in slide_data and slide.placeholders[1]:
            content = slide.placeholders[1]
            content.text = '\n'.join([f'â€¢ {item}' for item in slide_data['content']])
            
            # ê¸€ê¼´ í¬ê¸° ì¡°ì •
            for paragraph in content.text_frame.paragraphs:
                paragraph.font.size = Pt(18)
                paragraph.space_after = Pt(12)

print('PowerPoint í”„ë ˆì  í…Œì´ì…˜ ìƒì„± ì¤‘...')
prs.save('output/chrome_education_slides.pptx')
print('âœ… PowerPoint íŒŒì¼ ìƒì„± ì™„ë£Œ: chrome_education_slides.pptx')
"
        echo "âœ… PowerPoint generation completed"
        
    - name: List generated files
      run: |
        echo "ğŸ“‹ Generated files:"
        ls -la output/
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      with:
        enablement: true
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './output'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

