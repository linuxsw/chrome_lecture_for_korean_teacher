name: Build and Deploy Enhanced Chrome Education Materials

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wkhtmltopdf pandoc bc
        # í•œê¸€ í°íŠ¸ ì„¤ì¹˜ (PDF í•œê¸€ ì§€ì›)
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
        sudo fc-cache -fv
        echo "âœ… System dependencies installed"
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-pptx pillow weasyprint markdown reportlab
        echo "âœ… Python dependencies installed"
        
    - name: Create directories
      run: |
        mkdir -p output docs
        echo "âœ… Directories created"
      
    - name: Generate enhanced materials
      run: |
        echo "ğŸš€ Starting enhanced material generation..."
        
        # í–¥ìƒëœ ìë£Œ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        bash scripts/generate_materials_enhanced.sh
        
        echo "âœ… Enhanced material generation completed"
        
    - name: Verify generated files
      run: |
        echo "ğŸ“‹ Generated files verification:"
        echo "----------------------------------------"
        
        if [ -f "output/index.html" ]; then
          size=$(stat -c%s "output/index.html")
          echo "âœ… HTML Index: $(printf "%'d" $size) bytes"
        else
          echo "âŒ HTML Index: Missing"
        fi
        
        if [ -f "output/chrome_education_slides.pptx" ]; then
          size=$(stat -c%s "output/chrome_education_slides.pptx")
          mb=$(echo "scale=1; $size / 1024 / 1024" | bc -l)
          echo "âœ… PowerPoint: $(printf "%'d" $size) bytes (${mb} MB)"
        else
          echo "âŒ PowerPoint: Missing"
        fi
        
        if [ -f "output/chrome_edu_workbook.pdf" ]; then
          size=$(stat -c%s "output/chrome_edu_workbook.pdf")
          kb=$(echo "scale=1; $size / 1024" | bc -l)
          echo "âœ… PDF Workbook: $(printf "%'d" $size) bytes (${kb} KB)"
        else
          echo "âš ï¸ PDF Workbook: Missing (optional)"
        fi
        
        # HTML ìŠ¬ë¼ì´ë“œ íŒŒì¼ë“¤ ê°œìˆ˜
        html_count=$(find output -name "*.html" -not -name "index.html" | wc -l)
        echo "âœ… HTML Slides: ${html_count} files"
        
        # Assets í™•ì¸
        if [ -d "output/assets" ]; then
          asset_count=$(find output/assets -type f | wc -l)
          echo "âœ… Assets: ${asset_count} files"
        fi
        
        # ì´ë¯¸ì§€ í™•ì¸
        if [ -d "output/images" ]; then
          image_count=$(find output/images -type f | wc -l)
          echo "âœ… Images: ${image_count} files"
        fi
        
        echo "----------------------------------------"
        echo "ğŸ“‚ Complete file listing:"
        ls -la output/
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      with:
        enablement: true
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './output'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

