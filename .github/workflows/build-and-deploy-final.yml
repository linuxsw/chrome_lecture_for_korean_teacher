name: Build and Deploy Final Chrome Education Materials

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wkhtmltopdf pandoc bc
        # í•œê¸€ í°íŠ¸ ì„¤ì¹˜ (PDF í•œê¸€ ì§€ì›)
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
        sudo fc-cache -fv
        echo "âœ… System dependencies installed"
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-pptx pillow weasyprint markdown
        echo "âœ… Python dependencies installed"
        
    - name: Restore Commit 3bbe342 slides and images
      run: |
        echo "ğŸ”„ Restoring Commit 3bbe342 slides and images..."
        
        # ìŠ¬ë¼ì´ë“œ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p slides_3bbe342/images
        
        # HTML ìŠ¬ë¼ì´ë“œ íŒŒì¼ë“¤ ë³µì›
        for file in title_slide.html course_overview.html basic_features.html extensions_intro.html korean_edu_tools.html advanced_collab.html ai_tools.html practice_scenarios.html resources.html qa_contact.html; do
          git show 3bbe342:slides/$file > slides_3bbe342/$file
          echo "  âœ… Restored: $file"
        done
        
        # ì´ë¯¸ì§€ íŒŒì¼ë“¤ ë³µì›
        for img in chrome_extensions.png chrome_logo.png cloud_collaboration.png digital_tools.jpg korean_school.jpg online_korean_class.jpg; do
          git show 3bbe342:slides/images/$img > slides_3bbe342/images/$img
          echo "  âœ… Restored image: $img"
        done
        
        echo "âœ… Commit 3bbe342 restoration completed"
        
    - name: Create directories
      run: |
        mkdir -p output docs
        echo "âœ… Directories created"
      
    - name: Generate all materials with different methods
      run: |
        echo "ğŸš€ Starting integrated material generation..."
        
        # í†µí•© ìë£Œ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        chmod +x scripts/generate_all_materials.sh
        
        # í†µí•© ìë£Œ ìƒì„± ì‹¤í–‰
        bash scripts/generate_all_materials.sh
        
        echo "âœ… Integrated material generation completed"
        
    - name: Verify generated files with detailed info
      run: |
        echo "ğŸ“‹ Final verification with detailed information:"
        echo "=============================================="
        
        # í•„ìˆ˜ íŒŒì¼ë“¤ í™•ì¸
        REQUIRED_FILES=(
          "output/index.html"
          "output/chrome_education_slides.pptx"
          "output/chrome_edu_workbook.pdf"
        )
        
        ALL_GOOD=true
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file")
            echo "âœ… $(basename $file): $(printf "%'d" $size) bytes"
            
            # íŒŒì¼ë³„ ìƒì„¸ ì •ë³´
            case "$file" in
              *index.html)
                echo "   ğŸ“„ HTML Pages (Commit 3bbe342 + timestamp)"
                ;;
              *chrome_education_slides.pptx)
                mb=$(echo "scale=1; $size / 1024 / 1024" | bc -l)
                echo "   ğŸ“Š PowerPoint (Aspose style + Commit 3bbe342 images) - ${mb} MB"
                ;;
              *chrome_edu_workbook.pdf)
                kb=$(echo "scale=1; $size / 1024" | bc -l)
                echo "   ğŸ“š PDF Workbook (Commit 4a9b4e9 method) - ${kb} KB"
                ;;
            esac
          else
            echo "âŒ $(basename $file): Missing (REQUIRED)"
            ALL_GOOD=false
          fi
        done
        
        # HTML ìŠ¬ë¼ì´ë“œ ê°œìˆ˜ í™•ì¸
        html_count=$(find output -name "*.html" -not -name "index.html" | wc -l)
        echo "ğŸ“„ Individual HTML slides: ${html_count} files"
        
        # ì´ë¯¸ì§€ ê°œìˆ˜ í™•ì¸
        if [ -d "output/images" ]; then
          image_count=$(find output/images -type f | wc -l)
          echo "ğŸ–¼ï¸ Images: ${image_count} files"
        fi
        
        echo "=============================================="
        
        if [ "$ALL_GOOD" = false ]; then
          echo "âŒ Required files are missing. Build failed."
          exit 1
        fi
        
        echo "ğŸ‰ All files generated successfully!"
        echo "ğŸ“Š Build summary:"
        echo "  â€¢ HTML: Commit 3bbe342 original slides + timestamp"
        echo "  â€¢ PPTX: Aspose-style with Commit 3bbe342 images"
        echo "  â€¢ PDF: Commit 4a9b4e9 method with Korean font support"
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      with:
        enablement: true
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './output'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

