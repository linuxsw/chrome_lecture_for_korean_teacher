name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wkhtmltopdf pandoc zip
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install markdown weasyprint reportlab
        
    - name: Generate materials
      run: |
        echo "ðŸš€ Generating materials for release..."
        
        # ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p output
        
        # ìŠ¬ë¼ì´ë“œ ë° ìžë£Œ ìƒì„±
        python scripts/generate_slides.py
        bash scripts/generate_materials.sh
        
        # PDF ìƒì„± (ì›Œí¬ë¶ì´ ìžˆëŠ” ê²½ìš°)
        if [ -f "docs/chrome_edu_workbook.md" ]; then
          pandoc docs/chrome_edu_workbook.md -o output/chrome_edu_workbook.pdf \
            --pdf-engine=wkhtmltopdf \
            --margin-top=20mm \
            --margin-bottom=20mm \
            --margin-left=15mm \
            --margin-right=15mm
        fi
        
        echo "âœ… Material generation completed"
        
    - name: Create release package
      run: |
        echo "ðŸ“¦ Creating release package..."
        
        # ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p release-package
        
        # ì£¼ìš” íŒŒì¼ë“¤ì„ ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ì— ë³µì‚¬
        cp -r output/* release-package/
        cp -r docs release-package/
        cp README.md release-package/
        cp -r scripts release-package/
        
        # ì••ì¶• íŒŒì¼ ìƒì„±
        cd release-package
        zip -r ../chrome-education-materials-${{ github.ref_name }}.zip .
        cd ..
        
        # ê°œë³„ íŒŒì¼ë“¤ë„ ì¤€ë¹„
        cp output/chrome_edu_workbook.pdf chrome-education-workbook-${{ github.ref_name }}.pdf 2>/dev/null || true
        cp output/index.html chrome-education-slides-${{ github.ref_name }}.html 2>/dev/null || true
        
        echo "âœ… Release package created"
        
    - name: Get release info
      id: release_info
      run: |
        # íƒœê·¸ì—ì„œ ë²„ì „ ì •ë³´ ì¶”ì¶œ
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
        cat > release_notes.md << EOF
        # í•œê¸€í•™êµ ì„ ìƒë‹˜ì„ ìœ„í•œ í¬ë¡¬ ì›¹ë¸Œë¼ìš°ì € í™œìš© êµìœ¡ ìžë£Œ $VERSION
        
        ## ðŸ“š í¬í•¨ëœ ìžë£Œ
        
        - **ìŠ¬ë¼ì´ë“œ í”„ë ˆì  í…Œì´ì…˜**: ê¸°ì´ˆë¶€í„° ê³ ê¸‰ê¹Œì§€ ë‹¨ê³„ë³„ êµìœ¡ ìŠ¬ë¼ì´ë“œ
        - **ì‹¤ìŠµ ì›Œí¬ë¶**: ì‹¤ì œ ìƒí™© ê¸°ë°˜ ì‹¤ìŠµ ê°€ì´ë“œ (PDF)
        - **êµìœ¡ ìžë£Œ**: ì¡°ì‚¬ ìžë£Œ ë° ì»¤ë¦¬í˜ëŸ¼ ì„¤ê³„ ë¬¸ì„œ
        - **ìžë™í™” ìŠ¤í¬ë¦½íŠ¸**: êµìœ¡ ìžë£Œ ìƒì„± ë° ê´€ë¦¬ ë„êµ¬
        
        ## ðŸš€ ì‚¬ìš© ë°©ë²•
        
        1. **ì „ì²´ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ**: \`chrome-education-materials-$VERSION.zip\`
        2. **ê°œë³„ íŒŒì¼ ë‹¤ìš´ë¡œë“œ**: í•„ìš”í•œ íŒŒì¼ë§Œ ì„ íƒì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
        3. **ì˜¨ë¼ì¸ ë²„ì „**: [GitHub Pagesì—ì„œ ë°”ë¡œ ë³´ê¸°](https://linuxsw.github.io/chrome_lecture_for_korean_teacher/)
        
        ## ðŸ“– ë¬¸ì„œ
        
        ìžì„¸í•œ ì‚¬ìš©ë²•ì€ [README.md](https://github.com/linuxsw/chrome_lecture_for_korean_teacher/blob/main/README.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
        
        ## ðŸ”„ ìžë™ ì—…ë°ì´íŠ¸
        
        ì´ ìžë£ŒëŠ” GitHub Actionsë¥¼ í†µí•´ ìžë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. 
        ì†ŒìŠ¤ ì½”ë“œê°€ ì—…ë°ì´íŠ¸ë˜ë©´ ìžë™ìœ¼ë¡œ ìƒˆë¡œìš´ ë²„ì „ì´ ìƒì„±ë©ë‹ˆë‹¤.
        EOF
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Chrome Education Materials ${{ steps.release_info.outputs.version }}
        body_path: release_notes.md
        files: |
          chrome-education-materials-${{ github.ref_name }}.zip
          chrome-education-workbook-${{ github.ref_name }}.pdf
          chrome-education-slides-${{ github.ref_name }}.html
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

