name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wkhtmltopdf pandoc zip
        # í•œê¸€ í°íŠ¸ ì„¤ì¹˜
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
        sudo fc-cache -fv
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install markdown weasyprint reportlab python-pptx
        
    - name: Generate materials
      run: |
        echo "ğŸš€ Generating materials for release..."
        
        # ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p output
        
        # ìŠ¬ë¼ì´ë“œ ë° ìë£Œ ìƒì„±
        python scripts/generate_slides.py
        bash scripts/generate_materials.sh
        
        # PDF ìƒì„± (ì›Œí¬ë¶ì´ ìˆëŠ” ê²½ìš°)
        if [ -f "docs/chrome_edu_workbook.md" ]; then
          echo "ğŸ“š Converting workbook to PDF..."
          
          # WeasyPrint ì‚¬ìš© (í•œê¸€ ì§€ì› ìš°ìˆ˜)
          if python -c "import weasyprint" 2>/dev/null; then
            echo "Using WeasyPrint for PDF generation..."
            python -c "
import weasyprint
import markdown

# CSS ìŠ¤íƒ€ì¼ ì •ì˜ (í•œê¸€ í°íŠ¸ í¬í•¨)
css_style = '''
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
body {
    font-family: 'Noto Sans KR', 'Noto Sans CJK KR', sans-serif;
    line-height: 1.6;
    margin: 2cm;
    font-size: 12pt;
}
h1, h2, h3, h4, h5, h6 {
    font-weight: 700;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
}
h1 { font-size: 24pt; }
h2 { font-size: 20pt; }
h3 { font-size: 16pt; }
'''

# Markdownì„ HTMLë¡œ ë³€í™˜
with open('docs/chrome_edu_workbook.md', 'r', encoding='utf-8') as f:
    md_content = f.read()

html_content = f'''
<!DOCTYPE html>
<html lang=\"ko\">
<head>
    <meta charset=\"UTF-8\">
    <style>{css_style}</style>
</head>
<body>
{markdown.markdown(md_content)}
</body>
</html>
'''

# PDF ìƒì„±
weasyprint.HTML(string=html_content).write_pdf('output/chrome_edu_workbook.pdf')
print('âœ… PDF generated successfully with WeasyPrint')
"
          else
            echo "WeasyPrint not available, using Pandoc..."
            pandoc docs/chrome_edu_workbook.md -o output/chrome_edu_workbook.pdf \
              --pdf-engine=wkhtmltopdf \
              -V margin-top=20mm \
              -V margin-bottom=20mm \
              -V margin-left=15mm \
              -V margin-right=15mm \
              -V mainfont="Noto Sans CJK KR"
          fi
        fi
        
        # PowerPoint ìƒì„±
        echo "ğŸ“Š Creating PowerPoint presentation..."
        python -c "
from pptx import Presentation
from pptx.util import Pt
from pptx.dml.color import RGBColor

# ìŠ¬ë¼ì´ë“œ êµ¬ì„± ì •ë³´
slides_config = [
    {'title': 'ìˆ˜ì—…ì„ ì‰½ê²Œ, ìë£Œë¥¼ ì˜ˆì˜ê²Œ, í˜‘ì—…ì„ íš¨ìœ¨ì ìœ¼ë¡œ', 'subtitle': 'ë””ì§€í„¸ ë„êµ¬ ì™„ì „ì •ë³µ\ní•œê¸€í•™êµ ì„ ìƒë‹˜ì„ ìœ„í•œ í¬ë¡¬ ì›¹ë¸Œë¼ìš°ì € í™œìš© êµìœ¡'},
    {'title': 'ê°•ì˜ ê°œìš”', 'content': ['êµìœ¡ ëª©í‘œ ë° ëŒ€ìƒ', 'ê¸°ì´ˆ-ì¤‘ê¸‰-ê³ ê¸‰ ë‹¨ê³„ë³„ êµ¬ì„±', 'ì‹¤ìŠµ ì¤‘ì‹¬ì˜ í•™ìŠµ ë°©ë²•', 'ì§€ì†ì ì¸ í•™ìŠµì„ ìœ„í•œ ì»¤ë®¤ë‹ˆí‹°']},
    {'title': 'ê¸°ì´ˆ ë‹¨ê³„: í¬ë¡¬ ë¸Œë¼ìš°ì € ê¸°ë³¸ ê¸°ëŠ¥', 'content': ['í”„ë¡œí•„ ê´€ë¦¬', 'ë¶ë§ˆí¬ í™œìš©', 'ë‹¨ì¶•í‚¤ í™œìš©', 'ê¸°ë³¸ ì„¤ì • ìµœì í™”']},
    {'title': 'ì¤‘ê¸‰ ë‹¨ê³„: êµìœ¡ìë¥¼ ìœ„í•œ í™•ì¥í”„ë¡œê·¸ë¨', 'content': ['Fireshot - ì›¹í˜ì´ì§€ ìº¡ì²˜', 'Google Keep - ë©”ëª¨ ë° ìŠ¤í¬ë©', 'Video Speed Controller - ë™ì˜ìƒ ì†ë„ ì¡°ì ˆ', 'Mote - ìŒì„± í”¼ë“œë°±']},
    {'title': 'ì¤‘ê¸‰ ë‹¨ê³„: í•œê¸€êµìœ¡ íŠ¹í™” ì›¹ë„êµ¬', 'content': ['ìŠ¤í„°ë””ì½”ë¦¬ì•ˆë„·', 'í•œêµ­ì–´êµìˆ˜í•™ìŠµìƒ˜í„°', 'NAKS ì˜¨ë¼ì¸ ìë£Œì‹¤', 'í•œê¸€ë˜ë°•ë˜ë°•']},
    {'title': 'ê³ ê¸‰ ë‹¨ê³„: êµ¬ê¸€ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì—°ë™', 'content': ['êµ¬ê¸€ í´ë˜ìŠ¤ë£¸', 'êµ¬ê¸€ ë¬¸ì„œ/ìŠ¬ë¼ì´ë“œ', 'êµ¬ê¸€ ë“œë¼ì´ë¸Œ', 'êµ¬ê¸€ ë¯¸íŠ¸']},
    {'title': 'ê³ ê¸‰ ë‹¨ê³„: AI ë„êµ¬ í™œìš©', 'content': ['Brisk Teaching - AI êµì‚¬ ì–´ì‹œìŠ¤í„´íŠ¸', 'ChatGPT - êµìœ¡ ìë£Œ ìƒì„±', 'Canva AI - ì‹œê°ì  ìë£Œ ì œì‘', 'ìŒì„± ì¸ì‹/í•©ì„± ë„êµ¬']},
    {'title': 'ì‹¤ìŠµ ì‹œë‚˜ë¦¬ì˜¤', 'content': ['ìƒˆ í•™ê¸° ì¤€ë¹„ (ê¸°ì´ˆ)', 'íš¨ìœ¨ì ì¸ ìˆ˜ì—… ìë£Œ ì¤€ë¹„ (ì¤‘ê¸‰)', 'ì˜¨ë¼ì¸ ìˆ˜ì—… ì§„í–‰ (ì¤‘ê¸‰)', 'í•™ê¸‰ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶• (ê³ ê¸‰)']},
    {'title': 'ì¶”ê°€ ìë£Œ ë° ì°¸ê³  ë§í¬', 'content': ['í¬ë¡¬ ë¸Œë¼ìš°ì € ê³µì‹ ìë£Œ', 'í•œê¸€êµìœ¡ ìë£Œ', 'ë””ì§€í„¸ êµìœ¡ ë„êµ¬', 'êµì‚¬ ì»¤ë®¤ë‹ˆí‹°']},
    {'title': 'ì§ˆë¬¸ ë° ì—°ë½ì²˜', 'content': ['ì´ë©”ì¼: support@koreanedu.org', 'ì „í™”: 02-123-4567', 'ì›¹ì‚¬ì´íŠ¸: www.koreanedu.org']}
]

# ìƒˆ í”„ë ˆì  í…Œì´ì…˜ ìƒì„±
prs = Presentation()
chrome_blue = RGBColor(66, 133, 244)

for i, slide_data in enumerate(slides_config):
    slide_layout = prs.slide_layouts[0] if i == 0 else prs.slide_layouts[1]
    slide = prs.slides.add_slide(slide_layout)
    
    title = slide.shapes.title
    title.text = slide_data['title']
    title.text_frame.paragraphs[0].font.size = Pt(32)
    title.text_frame.paragraphs[0].font.color.rgb = chrome_blue
    
    if i == 0 and slide.placeholders[1]:
        subtitle = slide.placeholders[1]
        subtitle.text = slide_data['subtitle']
        subtitle.text_frame.paragraphs[0].font.size = Pt(20)
    elif 'content' in slide_data and slide.placeholders[1]:
        content = slide.placeholders[1]
        content.text = '\n'.join([f'â€¢ {item}' for item in slide_data['content']])
        for paragraph in content.text_frame.paragraphs:
            paragraph.font.size = Pt(18)

prs.save('output/chrome_education_slides.pptx')
print('âœ… PowerPoint íŒŒì¼ ìƒì„± ì™„ë£Œ')
"
        
        echo "âœ… Material generation completed"
        
    - name: Create release package
      run: |
        echo "ğŸ“¦ Creating release package..."
        
        # ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p release-package
        
        # ì£¼ìš” íŒŒì¼ë“¤ì„ ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ì— ë³µì‚¬
        cp -r output/* release-package/
        cp -r docs release-package/
        cp README.md release-package/
        cp -r scripts release-package/
        
        # ì••ì¶• íŒŒì¼ ìƒì„±
        cd release-package
        zip -r ../chrome-education-materials-${{ github.ref_name }}.zip .
        cd ..
        
        # ê°œë³„ íŒŒì¼ë“¤ë„ ì¤€ë¹„
        cp output/chrome_edu_workbook.pdf chrome-education-workbook-${{ github.ref_name }}.pdf 2>/dev/null || true
        cp output/index.html chrome-education-slides-${{ github.ref_name }}.html 2>/dev/null || true
        cp output/chrome_education_slides.pptx chrome-education-slides-${{ github.ref_name }}.pptx 2>/dev/null || true
        
        echo "âœ… Release package created"
        
    - name: Get release info
      id: release_info
      run: |
        # íƒœê·¸ì—ì„œ ë²„ì „ ì •ë³´ ì¶”ì¶œ
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
        cat > release_notes.md << EOF
        # í•œê¸€í•™êµ ì„ ìƒë‹˜ì„ ìœ„í•œ í¬ë¡¬ ì›¹ë¸Œë¼ìš°ì € í™œìš© êµìœ¡ ìë£Œ $VERSION
        
        ## ğŸ“š í¬í•¨ëœ ìë£Œ
        
        - **ìŠ¬ë¼ì´ë“œ í”„ë ˆì  í…Œì´ì…˜**: ê¸°ì´ˆë¶€í„° ê³ ê¸‰ê¹Œì§€ ë‹¨ê³„ë³„ êµìœ¡ ìŠ¬ë¼ì´ë“œ
        - **ì‹¤ìŠµ ì›Œí¬ë¶**: ì‹¤ì œ ìƒí™© ê¸°ë°˜ ì‹¤ìŠµ ê°€ì´ë“œ (PDF)
        - **êµìœ¡ ìë£Œ**: ì¡°ì‚¬ ìë£Œ ë° ì»¤ë¦¬í˜ëŸ¼ ì„¤ê³„ ë¬¸ì„œ
        - **ìë™í™” ìŠ¤í¬ë¦½íŠ¸**: êµìœ¡ ìë£Œ ìƒì„± ë° ê´€ë¦¬ ë„êµ¬
        
        ## ğŸš€ ì‚¬ìš© ë°©ë²•
        
        1. **ì „ì²´ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ**: \`chrome-education-materials-$VERSION.zip\`
        2. **ê°œë³„ íŒŒì¼ ë‹¤ìš´ë¡œë“œ**: í•„ìš”í•œ íŒŒì¼ë§Œ ì„ íƒì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
        3. **ì˜¨ë¼ì¸ ë²„ì „**: [GitHub Pagesì—ì„œ ë°”ë¡œ ë³´ê¸°](https://linuxsw.github.io/chrome_lecture_for_korean_teacher/)
        
        ## ğŸ“– ë¬¸ì„œ
        
        ìì„¸í•œ ì‚¬ìš©ë²•ì€ [README.md](https://github.com/linuxsw/chrome_lecture_for_korean_teacher/blob/main/README.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
        
        ## ğŸ”„ ìë™ ì—…ë°ì´íŠ¸
        
        ì´ ìë£ŒëŠ” GitHub Actionsë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. 
        ì†ŒìŠ¤ ì½”ë“œê°€ ì—…ë°ì´íŠ¸ë˜ë©´ ìë™ìœ¼ë¡œ ìƒˆë¡œìš´ ë²„ì „ì´ ìƒì„±ë©ë‹ˆë‹¤.
        EOF
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: Chrome Education Materials ${{ steps.release_info.outputs.version }}
        body_path: release_notes.md
        files: |
          chrome-education-materials-${{ github.ref_name }}.zip
          chrome-education-workbook-${{ github.ref_name }}.pdf
          chrome-education-slides-${{ github.ref_name }}.html
          chrome-education-slides-${{ github.ref_name }}.pptx
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

