name: Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  pages: read

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wkhtmltopdf pandoc fonts-noto-cjk fonts-noto-cjk-extra zip
          sudo fc-cache -fv

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-pptx pillow weasyprint markdown reportlab

      - name: Generate release materials
        run: |
          echo "ğŸš€ Generating release materials..."
          bash scripts/generate_materials.sh
          echo "âœ… Release materials generated"

      - name: Prepare release assets
        run: |
          echo "ğŸ“¦ Preparing release assets..."

          # ë¦´ë¦¬ì¦ˆìš© ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p release-assets

          # PowerPoint íŒŒì¼ ë³µì‚¬
          PPTX_FILE=$(find output -name "chrome_education_slides_*.pptx" | head -n 1)
          if [ -n "$PPTX_FILE" ]; then
            cp "$PPTX_FILE" release-assets/chrome_education_slides.pptx
            echo "âœ… PowerPoint file prepared"
          fi

          # PDF íŒŒì¼ ë³µì‚¬
          PDF_FILE=$(find output -name "chrome_edu_workbook_*.pdf" | head -n 1)
          if [ -n "$PDF_FILE" ]; then
            cp "$PDF_FILE" release-assets/chrome_edu_workbook.pdf
            echo "âœ… PDF file prepared"
          fi

          # HTML ìŠ¬ë¼ì´ë“œ ì••ì¶•
          cd output
          zip -r ../release-assets/chrome_education_slides_html.zip *.html images/ -x "chrome_*.html" "curriculum_*.html"
          cd ..

          echo "âœ… Release assets prepared"

      - name: Get file information
        id: file_info
        run: |
          PPTX_FILE="release-assets/chrome_education_slides.pptx"
          PDF_FILE="release-assets/chrome_edu_workbook.pdf"
          ZIP_FILE="release-assets/chrome_education_slides_html.zip"

          if [ -f "$PPTX_FILE" ]; then
            size=$(stat -c%s "$PPTX_FILE")
            PPTX_SIZE="$(awk "BEGIN {printf \"%.1f\", $size / 1024 / 1024}") MB"
            echo "pptx_size=$PPTX_SIZE" >> $GITHUB_OUTPUT
          fi

          if [ -f "$PDF_FILE" ]; then
            size=$(stat -c%s "$PDF_FILE")
            PDF_SIZE="$(awk "BEGIN {printf \"%.1f\", $size / 1024}") KB"
            echo "pdf_size=$PDF_SIZE" >> $GITHUB_OUTPUT
          fi

          if [ -f "$ZIP_FILE" ]; then
            size=$(stat -c%s "$ZIP_FILE")
            HTML_SIZE="$(awk "BEGIN {printf \"%.1f\", $size / 1024}") KB"
            echo "html_size=$HTML_SIZE" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.tag_name || github.ref_name }}
          release_name: Chrome Education Materials ${{ github.event.inputs.tag_name || github.ref_name }}
          body: |
            # í•œê¸€í•™êµ ì„ ìƒë‹˜ì„ ìœ„í•œ í¬ë¡¬ ì›¹ë¸Œë¼ìš°ì € í™œìš© êµìœ¡ ìë£Œ

            ## ğŸ“š í¬í•¨ëœ ìë£Œ

            - **PowerPoint í”„ë ˆì  í…Œì´ì…˜** (${{ steps.file_info.outputs.pptx_size }}): ì˜¤í”„ë¼ì¸ ê°•ì˜ìš© ìŠ¬ë¼ì´ë“œ
            - **ì‹¤ìŠµ ì›Œí¬ë¶ PDF** (${{ steps.file_info.outputs.pdf_size }}): ë‹¨ê³„ë³„ ì‹¤ìŠµ ê°€ì´ë“œ
            - **HTML ìŠ¬ë¼ì´ë“œ** (${{ steps.file_info.outputs.html_size }}): ì›¹ ê¸°ë°˜ í”„ë ˆì  í…Œì´ì…˜

            ## ğŸŒ ì˜¨ë¼ì¸ ë²„ì „

            - [GitHub Pagesì—ì„œ ë³´ê¸°](https://linuxsw.github.io/chrome_lecture_for_korean_teacher/)

            ## ğŸ“– ì‚¬ìš© ë°©ë²•

            1. **PowerPoint**: ë‹¤ìš´ë¡œë“œ í›„ ë°”ë¡œ ê°•ì˜ì— ì‚¬ìš©
            2. **PDF ì›Œí¬ë¶**: ì‹¤ìŠµ ê°€ì´ë“œë¡œ í™œìš©
            3. **HTML ìŠ¬ë¼ì´ë“œ**: ì••ì¶• í•´ì œ í›„ index.html ì‹¤í–‰

            ---

            ìƒì„±ì¼: $(date '+%Yë…„ %mì›” %dì¼')
          draft: false
          prerelease: false

      - name: Upload PowerPoint
        if: success()
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release-assets/chrome_education_slides.pptx
          asset_name: chrome_education_slides.pptx
          asset_content_type: application/vnd.openxmlformats-officedocument.presentationml.presentation

      - name: Upload PDF Workbook
        if: success()
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release-assets/chrome_edu_workbook.pdf
          asset_name: chrome_edu_workbook.pdf
          asset_content_type: application/pdf

      - name: Upload HTML Slides
        if: success()
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release-assets/chrome_education_slides_html.zip
          asset_name: chrome_education_slides_html.zip
          asset_content_type: application/zip
