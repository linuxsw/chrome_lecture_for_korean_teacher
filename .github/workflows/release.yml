name: Create Enhanced Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wkhtmltopdf pandoc zip bc
        # í•œê¸€ í°íŠ¸ ì„¤ì¹˜ (PDF í•œê¸€ ì§€ì›)
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
        sudo fc-cache -fv
        echo "âœ… System dependencies installed"
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-pptx pillow weasyprint markdown reportlab
        echo "âœ… Python dependencies installed"
        
    - name: Generate enhanced materials
      run: |
        echo "ðŸš€ Generating enhanced materials for release..."
        
        # í–¥ìƒëœ ìžë£Œ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        bash scripts/generate_materials_enhanced.sh
        
        echo "âœ… Enhanced material generation completed"
        
    - name: Verify generated files
      run: |
        echo "ðŸ“‹ Verifying generated files for release:"
        echo "----------------------------------------"
        
        # í•„ìˆ˜ íŒŒì¼ë“¤ í™•ì¸
        REQUIRED_FILES=(
          "output/index.html"
          "output/chrome_education_slides.pptx"
        )
        
        OPTIONAL_FILES=(
          "output/chrome_edu_workbook.pdf"
        )
        
        ALL_GOOD=true
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file")
            echo "âœ… $(basename $file): $(printf "%'d" $size) bytes"
          else
            echo "âŒ $(basename $file): Missing (REQUIRED)"
            ALL_GOOD=false
          fi
        done
        
        for file in "${OPTIONAL_FILES[@]}"; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file")
            echo "âœ… $(basename $file): $(printf "%'d" $size) bytes"
          else
            echo "âš ï¸ $(basename $file): Missing (optional)"
          fi
        done
        
        if [ "$ALL_GOOD" = false ]; then
          echo "âŒ Required files are missing. Release cannot proceed."
          exit 1
        fi
        
        echo "----------------------------------------"
        
    - name: Create release package
      run: |
        echo "ðŸ“¦ Creating enhanced release package..."
        
        # ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p release-package
        
        # ì£¼ìš” íŒŒì¼ë“¤ì„ ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ì— ë³µì‚¬
        cp -r output/* release-package/
        
        # ë¬¸ì„œ ë° ìŠ¤í¬ë¦½íŠ¸ í¬í•¨
        [ -d docs ] && cp -r docs release-package/
        cp README.md release-package/ 2>/dev/null || echo "README.md not found"
        cp -r scripts release-package/
        cp -r .github release-package/
        
        # ì••ì¶• íŒŒì¼ ìƒì„±
        cd release-package
        zip -r ../chrome-education-materials-${{ github.ref_name }}.zip .
        cd ..
        
        # ê°œë³„ íŒŒì¼ë“¤ë„ ì¤€ë¹„ (ë²„ì „ íƒœê·¸ í¬í•¨)
        if [ -f "output/chrome_edu_workbook.pdf" ]; then
          cp output/chrome_edu_workbook.pdf chrome-education-workbook-${{ github.ref_name }}.pdf
        fi
        
        if [ -f "output/index.html" ]; then
          cp output/index.html chrome-education-slides-${{ github.ref_name }}.html
        fi
        
        if [ -f "output/chrome_education_slides.pptx" ]; then
          cp output/chrome_education_slides.pptx chrome-education-slides-${{ github.ref_name }}.pptx
        fi
        
        echo "âœ… Enhanced release package created"
        
    - name: Get release info
      id: release_info
      run: |
        # íƒœê·¸ì—ì„œ ë²„ì „ ì •ë³´ ì¶”ì¶œ
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # íŒŒì¼ í¬ê¸° ì •ë³´ ìˆ˜ì§‘
        PPTX_SIZE=""
        PDF_SIZE=""
        HTML_SIZE=""
        
        if [ -f "output/chrome_education_slides.pptx" ]; then
          size=$(stat -c%s "output/chrome_education_slides.pptx")
          PPTX_SIZE="$(echo "scale=1; $size / 1024 / 1024" | bc -l) MB"
        fi
        
        if [ -f "output/chrome_edu_workbook.pdf" ]; then
          size=$(stat -c%s "output/chrome_edu_workbook.pdf")
          PDF_SIZE="$(echo "scale=1; $size / 1024" | bc -l) KB"
        fi
        
        if [ -f "output/index.html" ]; then
          size=$(stat -c%s "output/index.html")
          HTML_SIZE="$(echo "scale=1; $size / 1024" | bc -l) KB"
        fi
        
        # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
        cat > release_notes.md << EOF
        # í•œê¸€í•™êµ ì„ ìƒë‹˜ì„ ìœ„í•œ í¬ë¡¬ ì›¹ë¸Œë¼ìš°ì € í™œìš© êµìœ¡ ìžë£Œ $VERSION
        
        ## ðŸŽ¯ ì£¼ìš” íŠ¹ì§•
        
        - **ì‹œê°ì  ì™„ì„±ë„**: ë°°ê²½ ì´ë¯¸ì§€, ì•„ì´ì½˜, ê·¸ëž˜í”½ì´ í¬í•¨ëœ ê³ í’ˆì§ˆ ìŠ¬ë¼ì´ë“œ
        - **ë‹¤ì–‘í•œ í˜•ì‹**: HTML, PowerPoint, PDF í˜•ì‹ìœ¼ë¡œ ì œê³µ
        - **í•œê¸€ ì§€ì›**: ëª¨ë“  íŒŒì¼ì—ì„œ í•œê¸€ í°íŠ¸ ì •ìƒ í‘œì‹œ
        - **ì‹¤ìŠµ ì¤‘ì‹¬**: í•œê¸€í•™êµ í˜„ìž¥ì— ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ ì‹¤ìš©ì  ë‚´ìš©
        - **ìžë™ ìƒì„±**: GitHub Actionsë¡œ ìžë™ ë¹Œë“œ ë° ë°°í¬
        
        ## ðŸ“š í¬í•¨ëœ ìžë£Œ
        
        ### ðŸŽ¨ í”„ë ˆì  í…Œì´ì…˜ ìŠ¬ë¼ì´ë“œ (10ê°œ)
        - **HTML ìŠ¬ë¼ì´ë“œ**: ì˜¨ë¼ì¸ í”„ë ˆì  í…Œì´ì…˜ìš© ${HTML_SIZE:+($HTML_SIZE)}
        - **PowerPoint íŒŒì¼**: ì˜¤í”„ë¼ì¸ í”„ë ˆì  í…Œì´ì…˜ìš© ${PPTX_SIZE:+($PPTX_SIZE)}
        
        ### ðŸ“– ì‹¤ìŠµ ì›Œí¬ë¶
        - **PDF ì›Œí¬ë¶**: ë‹¨ê³„ë³„ ì‹¤ìŠµ ê°€ì´ë“œ ${PDF_SIZE:+($PDF_SIZE)}
        
        ### ðŸ› ï¸ ê°œë°œ ë„êµ¬
        - **ìžë™í™” ìŠ¤í¬ë¦½íŠ¸**: êµìœ¡ ìžë£Œ ìƒì„± ë° ê´€ë¦¬ ë„êµ¬
        - **GitHub Actions**: ìžë™ ë¹Œë“œ ë° ë°°í¬ ì›Œí¬í”Œë¡œìš°
        
        ## ðŸš€ ì‚¬ìš© ë°©ë²•
        
        ### 1. ì „ì²´ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ
        \`chrome-education-materials-$VERSION.zip\` - ëª¨ë“  íŒŒì¼ í¬í•¨
        
        ### 2. ê°œë³„ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        - **PowerPoint**: \`chrome-education-slides-$VERSION.pptx\`
        - **PDF ì›Œí¬ë¶**: \`chrome-education-workbook-$VERSION.pdf\`
        - **HTML ìŠ¬ë¼ì´ë“œ**: \`chrome-education-slides-$VERSION.html\`
        
        ### 3. ì˜¨ë¼ì¸ ë²„ì „
        [GitHub Pagesì—ì„œ ë°”ë¡œ ë³´ê¸°](https://linuxsw.github.io/chrome_lecture_for_korean_teacher/)
        
        ## ðŸ“‹ ìŠ¬ë¼ì´ë“œ êµ¬ì„±
        
        1. **íƒ€ì´í‹€ ìŠ¬ë¼ì´ë“œ** - êµìœ¡ í”„ë¡œê·¸ëž¨ ì†Œê°œ
        2. **ê°•ì˜ ê°œìš”** - êµìœ¡ ëª©í‘œ ë° ë‹¨ê³„ë³„ êµ¬ì„±
        3. **ê¸°ì´ˆ ë‹¨ê³„** - í¬ë¡¬ ë¸Œë¼ìš°ì € ê¸°ë³¸ ê¸°ëŠ¥
        4. **ì¤‘ê¸‰ ë‹¨ê³„ 1** - êµìœ¡ìžìš© í™•ìž¥í”„ë¡œê·¸ëž¨
        5. **ì¤‘ê¸‰ ë‹¨ê³„ 2** - í•œê¸€êµìœ¡ íŠ¹í™” ì›¹ë„êµ¬
        6. **ê³ ê¸‰ ë‹¨ê³„ 1** - êµ¬ê¸€ ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ ì—°ë™
        7. **ê³ ê¸‰ ë‹¨ê³„ 2** - AI ë„êµ¬ í™œìš©
        8. **ì‹¤ìŠµ ì‹œë‚˜ë¦¬ì˜¤** - ë‹¨ê³„ë³„ ì‹¤ìŠµ ê°€ì´ë“œ
        9. **ì¶”ê°€ ìžë£Œ** - ì°¸ê³  ë§í¬ ë° í•™ìŠµ ìžë£Œ
        10. **ì—°ë½ì²˜** - ë¬¸ì˜ ë° ì§€ì› ì •ë³´
        
        ## ðŸ’¡ í™œìš© íŒ
        
        ### êµìœ¡ í˜„ìž¥ì—ì„œ
        - **í”„ë¡œì í„° ì—°ê²°**: PowerPoint íŒŒì¼ë¡œ ì§ì ‘ í”„ë ˆì  í…Œì´ì…˜
        - **ì¸ì‡„ ë°°í¬**: PDF ì›Œí¬ë¶ì„ ì¸ì‡„í•˜ì—¬ ì‹¤ìŠµ ê°€ì´ë“œë¡œ í™œìš©
        - **ì˜¨ë¼ì¸ ìˆ˜ì—…**: HTML ìŠ¬ë¼ì´ë“œë¥¼ í™”ë©´ ê³µìœ ë¡œ ì§„í–‰
        
        ### ê°œì¸ í•™ìŠµìš©
        - **ëª¨ë°”ì¼ í•™ìŠµ**: ìŠ¤ë§ˆíŠ¸í°/íƒœë¸”ë¦¿ì—ì„œ PDF ì›Œí¬ë¶ í™œìš©
        - **ë°˜ë³µ í•™ìŠµ**: ì˜¨ë¼ì¸ ë²„ì „ìœ¼ë¡œ ì–¸ì œë“ ì§€ ë³µìŠµ
        - **ë§žì¶¤ ìˆ˜ì •**: PowerPoint íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬ ê°œì¸í™”
        
        ## ðŸ“– ë¬¸ì„œ
        
        ìžì„¸í•œ ì‚¬ìš©ë²•ê³¼ ì„¤ì¹˜ ê°€ì´ë“œëŠ” ë‹¤ìŒ ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ì„¸ìš”:
        - [README.md](https://github.com/linuxsw/chrome_lecture_for_korean_teacher/blob/main/README.md)
        - [INSTALL.md](https://github.com/linuxsw/chrome_lecture_for_korean_teacher/blob/main/INSTALL.md)
        - [CONTRIBUTING.md](https://github.com/linuxsw/chrome_lecture_for_korean_teacher/blob/main/CONTRIBUTING.md)
        
        ## ðŸ”„ ìžë™ ì—…ë°ì´íŠ¸
        
        ì´ ìžë£ŒëŠ” GitHub Actionsë¥¼ í†µí•´ ìžë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. 
        ì†ŒìŠ¤ ì½”ë“œê°€ ì—…ë°ì´íŠ¸ë˜ë©´ ìžë™ìœ¼ë¡œ ìƒˆë¡œìš´ ë²„ì „ì´ ìƒì„±ë©ë‹ˆë‹¤.
        
        ## ðŸ™ ê°ì‚¬ì˜ ë§
        
        í•œê¸€êµìœ¡ì˜ ë””ì§€í„¸ í˜ì‹ ì„ í•¨ê»˜ ë§Œë“¤ì–´ê°€ëŠ” ëª¨ë“  ì„ ìƒë‹˜ë“¤ê»˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤!
        EOF
        
    - name: Create Enhanced Release
      uses: softprops/action-gh-release@v2
      with:
        name: Chrome Education Materials ${{ steps.release_info.outputs.version }}
        body_path: release_notes.md
        files: |
          chrome-education-materials-${{ github.ref_name }}.zip
          chrome-education-workbook-${{ github.ref_name }}.pdf
          chrome-education-slides-${{ github.ref_name }}.html
          chrome-education-slides-${{ github.ref_name }}.pptx
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

